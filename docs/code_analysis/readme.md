# 源码分析

整个tidb无非就是一个分布式的sql数据库而已。既然是一个sql数据库，那么无非就是先client发送一个sql语句到server。然后sql语句肯定要经过类似mysql的那种处理过程——语法解析、创建并优化执行计划、执行。而这个执行过程中肯定是需要和数据打交道的，所以这里肯定是需要有一个底层的分布式存储引擎能够解决这个问题。

## 三层分层

1. 协议解析和转换

* 所有的逻辑都在 server 这个包中

* 主要逻辑分为两块：
  * 连接的建立和管理（每个连接对应于一个 Session）
  * 在单个连接上的处理逻辑

2. SQL 层的处理是整个 TiDB 最复杂的部分

* SQL 语言本身是一门复杂的语言
  * 语句的种类多、数据类型多、操作符多、语法组合多、排列组合后更多
  * 所以需要写大量的代码来处理
  * SQL 是一门表意的语言，需要一些复杂的逻辑选择『如何拿数据』也就是选择一个好的查询计划
* 底层是一个分布式存储引擎，会面临很多单机存储引擎不会遇到的问题
  * 比如做查询计划的时候要考虑到下层的数据是分片的、网络不通了如何处理等情况
  * 所以需要一些复杂的逻辑处理这些情况，并且需要一个很好的机制将这些处理逻辑封装起来
  * 这些复杂性是看懂源码比较大的障碍

* 这一层核心的接口如下
  * Session
  * RecordSet
  * Plan
  * LogicalPlan
  * PhysicalPlan
  * Executor

3. 存储引擎层

* KV接口层 —— 将请求路由到正确的KV Server,接收返回消息传给 SQL 层，并在此过程中处理各种异常逻辑
* KV Server 的具体实现

## 1 协议解析和转换

## 2 SQL Core层的处理

## 3 KV接口层、底层具体KV Server的实现
